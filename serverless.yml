service: converterservices
frameworkVersion: "2"

plugins:
  - serverless-offline
  - serverless-python-requirements
  - serverless-plugin-tracing
  - serverless-prune-plugin
  - serverless-aws-documentation
  - serverless-latest-layer-version

provider:
  name: aws
  runtime: python3.8
  lambdaHashingVersion: 20201221
  memorySize: 512
  timeout: 30
  region: ${file(./config.${self:provider.stage}.json):REGION}
  stage: ${opt:stage,'dev'}
  deploymentBucket:
    name: snet-serverless-artifacts # Deployment bucket name. Default is generated by the framework
    serverSideEncryption: AES256 # when using server-side encryption
    tags: # Tags that will be added to each of the deployment resources
      key1: converter-service
  deploymentPrefix: serverless
  tracing: true

custom:
  pythonRequirements:
    fileName: converter/requirements.txt
    dockerizePip: true
    useDownloadCache: true
    useStaticCache: true
    cacheLocation: "/var/cache/serverless"
  prune:
    automatic: true
    includeLayers: true
    number: 5
  defaultLayers:
    - ${file(./config.${self:provider.stage}.json):MplaceCommonCode_Layer}
    - ${file(./config.${self:provider.stage}.json):MplaceCommonPythonLib_Layer}
  defaultVpc:
    securityGroupIds:
      - ${file(./config.${self:provider.stage}.json):SG1}
      - ${file(./config.${self:provider.stage}.json):SG2}
    subnetIds:
      - ${file(./config.${self:provider.stage}.json):VPC1}
      - ${file(./config.${self:provider.stage}.json):VPC2}
  defaultCors:
    origin: ${file(./config.${self:provider.stage}.json):ORIGIN}
    headers:
      - Content-Type
      - X-Amz-Date
      - Authorization
      - X-Api-Key
      - X-Amz-Security-Token
      - X-Amz-User-Agent
      - x-requested-with

package:
  patterns:
    - "!.circleci/**"
    - "!.gitignore/**"
    - "!.serverless/**"
    - "!requirements.txt"
    - "!venv/**"
    - "!serverless.yml"
    - "!test/**"
    - "!tests/**"
    - "!repository/**"
    - "!Readme.md"
    - "!package.json"
    - "!Dockerfile"
    - "!License"
    - "!node_modules/**"

functions:
  get_blockchain:
    handler: converter/application/handler/blockchain_handlers.get_blockchain
    role: ${file(./config.${self:provider.stage}.json):ROLE}
    layers: ${self:custom.defaultLayers}
    events:
      - http:
          path: /v1/blockchain
          method: get
          cors: ${self:custom.defaultCors}


